name: Deploy AOF to DigitalOcean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLETS }}
          username: ${{ secrets.DROPLET_USERNAME }}
          password: ${{ secrets.SUDO_PASSWORD }}
          script: |
            set -e
            source venv/bin/activate
            cd aof
            git remote set-url origin git@github.com:Shami-Og/aof.git
            git fetch origin
            git reset --hard origin/main

            pip install -r requirements.txt

            # Attempt to run migrations normally
            {
              python manage.py migrate --fake
              python manage.py makemigrations --noinput
              python manage.py makemigrations --merge --noinput
              python manage.py migrate --noinput
            } || {
              # If normal migration fails, run migrations with --skip-checks
              python manage.py migrate --fake
              python manage.py makemigrations --noinput --skip-checks
              python manage.py makemigrations --merge --noinput --skip-checks
              python manage.py migrate --noinput --skip-checks
            }

            python manage.py collectstatic --noinput
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl restart gunicorn
